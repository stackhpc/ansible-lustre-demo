- hosts:
    - exporters
    - nfs_client
  gather_facts: yes
  become: yes
  vars:
    fio_size: 32G
    fio_cmds:
      std_read: "fio --randrepeat=1 --ioengine=libaio --direct=1 --gtod_reduce=1 --name=test --filename=fiotest-$(hostname) --bs=512k --iodepth=16 --size={{ fio_size }} --readwrite=randread --refill_buffers --numjobs={{ ansible_processor_count }}"
      std_write: "fio --ioengine=libaio --direct=1 --gtod_reduce=1 --name=test-write --filename=fiotest-$(hostname) --bs=4M --iodepth=256 --size={{ fio_size }} --readwrite=write --refill_buffers --numjobs={{ ansible_processor_count }}"
    
  tasks:
    - name: get filesystem for lustre mountpoint
      command:
        cmd: df --output=fstype /mnt/lustre/
      changed_when: false
      register: df_mnt_lustre
    - name: ensure /mnt/lustre is actually mounted
      assert:
        that: "'nfs' in df_mnt_lustre.stdout_lines[1] or 'lustre' in df_mnt_lustre.stdout_lines[1]"
        fail_msg: "/mnt/lustre is not an NFS or Lustre filesystem on host '{{ inventory_hostname}}'"
    - name: install fio
      package:
        name: fio
    - name: run fio
      shell:
        cmd: "{{ item.value }}"
        chdir: /mnt/lustre
      throttle: 1
      loop: "{{ fio_cmds | dict2items }}"
      register: _fio
    - debug:
        msg: "{{ _fio.results | map(attribute='stdout_lines') | map('last') | to_nice_yaml }}"

    
